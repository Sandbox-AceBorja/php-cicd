name: Deploy to InfinityFree

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json, pdo, pdo_mysql

    - name: Validate PHP syntax
      run: find ./src -name "*.php" -exec php -l {} \;

    - name: Check for syntax errors
      run: |
        echo "‚úì PHP syntax validation passed"

    - name: Check config.example.php exists
      run: |
        if [ ! -f src/config.example.php ]; then
          echo "‚ùå config.example.php not found!"
          exit 1
        fi
        echo "‚úì config.example.php exists"

    - name: Validate SQL migrations
      run: |
        if [ -d migrations ]; then
          echo "Checking SQL files..."
          for file in migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "‚úì Found: $file"
            fi
          done
        else
          echo "No migrations directory found"
        fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to InfinityFree via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./src/
        server-dir: /htdocs/
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/vendor/**
          **/.env
          **/config.php
          **/README.md
          **/index-secure.php
          **/migrate-secure.php

    - name: Deploy migrations
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./migrations/
        server-dir: /htdocs/migrations/

    - name: Deployment Success
      run: |
        echo "‚úì Deployment completed successfully!"
        echo "üåê Your site: https://php-cicd.free.nf"
        echo ""
        echo "‚ö†Ô∏è  IMPORTANT - First time setup:"
        echo "1. Upload config.php manually via FTP with your real credentials"
        echo "2. Or create config.php on server by copying config.example.php"
        echo "3. Make sure config.php is NOT in git (it's in .gitignore)"
        echo ""
        echo "üìù Next steps:"
        echo "1. Visit: https://php-cicd.free.nf/migrate.php?password=your_secret_password_123"
        echo "2. Run pending migrations"
        echo "3. Delete migrate.php for security"